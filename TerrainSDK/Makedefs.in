########################################################################
#
# TerrainSDK/Makedefs.in
#
# Copyright (c) 2002 Darren Erik Vengroff.  All rights reserved.
#
# $Id$
#
########################################################################

# This makefile contains definitions to build and install a library.
# The idea is that a makefile should define $(OBJS) and $(TARGET_LIB),
# then include this file to do all the real work.


# Where to install, and to find other things that we may want to
# include/link with.

prefix 		= @prefix@
exec_prefix 	= @exec_prefix@
includedir 	= @includedir@
libdir  	= @libdir@


# Figure out what to build based on a .dsp file (Windows build project
# file) to stay in sync.

DSP_HDR_LINES	= $(shell grep "^SOURCE=.*.h$$" $(DSP_FILE))
TARGET_HDRS	= $(subst SOURCE=,,$(subst \,/,$(DSP_HDR_LINES)))

DSP_C_LINES	= $(shell grep "^SOURCE=.*.c$$" $(DSP_FILE))
CFILES		= $(subst SOURCE=,,$(subst \,/,$(DSP_C_LINES)))

DSP_CXX_LINES	= $(shell grep "^SOURCE=.*.cpp$$" $(DSP_FILE))
CXXFILES	= $(subst SOURCE=,,$(subst \,/,$(DSP_CXX_LINES)))

OBJS   		= $(CFILES:%.c=%.o) $(CXXFILES:%.cpp=%.o)


# Compiler info:

CC 	 = @CC@
CXX 	 = @CXX@

CFLAGS   = @CFLAGS@ @X_CFLAGS@
CXXFLAGS = @CXXFLAGS@ @X_CFLAGS@

# Install info:

INSTALL = @INSTALL@

# We expect the makefile that includes us to define a target library
# to install, and a subdir to put headers in.

INSTALLED_LIB 	= $(libdir)/$(TARGET_LIB)

INSTALLED_HDRS  = $(TARGET_HDRS:%=$(includedir)/$(TARGET_HDR_SUBDIR)/%)

# How to compile it.  Mostly implicit.  GNU Make knows what to do to
# compile the .o's and then link them.

all: $(TARGET_LIB)

$(TARGET_LIB): $(OBJS)
	$(LINK.cc) -shared $^ $(LOADLIBES) $(LDLIBS) -o $@

# How to install:

install: $(INSTALLED_LIB) $(INSTALLED_HDRS)

$(INSTALLED_LIB): $(TARGET_LIB)
	$(INSTALL) -D $^ $@

$(includedir)/$(TARGET_HDR_SUBDIR)/%.h: %.h
	$(INSTALL) -D $^ $@

# How to clean up after ourselves:

clean:
	$(RM) $(OBJS) $(TARGET_LIB)

clobber: clean

uninstall:
	$(RM) $(INSTALLED_LIB)
	$(RM) $(INSTALLED_HDRS)

# Mainly for debugging:

print_dsp_targets:
	@echo ".dsp Headers: " $(TARGET_HDRS)
	@echo ".dsp Modules: " $(CXXFILES)


.PHONY: all install uninstall clean clobber print_dsp_targets
